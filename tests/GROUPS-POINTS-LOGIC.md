# منطق إضافة/خصم نقاط الأسرة والنسبة المئوية

## 1. إضافة نقاط للأسرة (زر +)

### 1.1 بدون "توزيع النقاط على الأفراد"
- **الفعل:** تُضاف النقاط كلها إلى **نقاط الأسرة المباشرة** فقط (`group_points_adjustments`).
- **النتيجة:** `نقاط الأفراد` لا يتغير، `نقاط الأسرة` يزيد، `الإجمالي` يزيد.

### 1.2 مع "توزيع النقاط على الأفراد"
- **الفعل:** تُوزَّع النقاط على الطلاب بالتساوي (قسمة صحيحة)، والباقي يُضاف للأسرة مباشرة.
  - `pointsPerMember = floor(points / عدد_الأعضاء)`
  - `remainder = points % عدد_الأعضاء`
  - كل طالب: +pointsPerMember في `points_adjustments`.
  - إذا remainder > 0: +remainder في `group_points_adjustments` (باقي التوزيع).
- **النتيجة:** `نقاط الأفراد` يزيد (مجموع نقاط الطلاب)، والباقي في `نقاط الأسرة`، `الإجمالي` يزيد.

---

## 2. خصم نقاط من الأسرة (زر -)

### 2.1 بدون "خصم من الأفراد أيضاً"
- **التحقق:** إجمالي نقاط الأسرة (أفراد + أسرة مباشرة) يجب أن يكون ≥ عدد النقاط المطلوب خصمه.
- **الفعل:** تُخصم النقاط من **نقاط الأسرة المباشرة** فقط (`group_points_adjustments` بقيمة سالبة).
- **النتيجة:** `نقاط الأسرة` ينقص، `الإجمالي` ينقص.

### 2.2 مع "خصم من الأفراد أيضاً"
- **الفعل:**
  - `pointsPerMember = floor(points / عدد_الأعضاء)`
  - `remainder = points % عدد_الأعضاء`
  - لكل طالب: نخصم **على الأكثر** `pointsPerMember` ولا نخصم أكثر من نقاطه الحالية.
    - `deduct = min(pointsPerMember, نقاط_الطالب)`
    - إدراج في `points_adjustments` بقيمة `-deduct`.
  - الباقي (ما لم يُخصم من الأفراد بسبب عدم كفاية النقاط) يُخصم من **نقاط الأسرة المباشرة**.
    - `toDeductFromGroup = points - totalDeductedFromMembers`
    - إدراج في `group_points_adjustments` بقيمة `-toDeductFromGroup`.
- **النتيجة:** لا يحدث أن تصبح نقاط طالب سالبة؛ الباقي يُخصم من الأسرة المباشرة.

---

## 3. زيادة مئوية (زر %+)

### 3.1 بدون "تطبيق الزيادة على الأفراد"
- **الفعل:** نحسب مجموع نقاط الأسرة (أفراد + أسرة مباشرة)، ثم نضيف `floor(المجموع × النسبة / 100)` إلى **نقاط الأسرة المباشرة** فقط.
- **النتيجة:** `نقاط الأسرة` يزيد، `الإجمالي` يزيد.

### 3.2 مع "تطبيق الزيادة على الأفراد"
- **الفعل:** لكل طالب: `change = floor(نقاط_الطالب × النسبة / 100)`؛ إذا `change >= 1` نضيف `change` في `points_adjustments`.
- **النتيجة:** `نقاط الأفراد` يزيد، `الإجمالي` يزيد.

---

## 4. خصم مئوي (زر %-)

### 4.1 بدون "تطبيق الخصم على الأفراد"
- **التحقق:** نقاط الأسرة المباشرة يجب أن تكون ≥ القيمة المحسوبة للخصم (لا نخصم أكثر من الموجود في المباشر).
- **الفعل:** نحسب مجموع نقاط الأسرة، ثم `groupBonus = floor(المجموع × النسبة / 100)` ونخصم من **نقاط الأسرة المباشرة** فقط (إدراج `-groupBonus` في `group_points_adjustments`).
- **النتيجة:** `نقاط الأسرة` ينقص، `الإجمالي` ينقص.

### 4.2 مع "تطبيق الخصم على الأفراد"
- **الفعل:** لكل طالب: `change = floor(نقاط_الطالب × النسبة / 100)`؛ إذا `change >= 1` **ونقاط الطالب ≥ change** نخصم `change` (إدراج `-change` في `points_adjustments`). إذا نقاط الطالب أقل من change نتخطاه (لا نخصم أكثر من نقاطه).
- **النتيجة:** لا تصبح نقاط طالب سالبة؛ `نقاط الأفراد` ينقص حسب ما تم خصمه فعلياً.

---

## تشغيل الاختبارات التلقائية

1. شغّل السيرفر: `npm start`
2. في طرفية أخرى: `npm run test:groups`

يجب أن تمر كل الاختبارات بدون أخطاء.
